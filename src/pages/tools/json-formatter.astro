---
import Layout from '../../layouts/Layout.astro';
import ToolHeader from '../../components/ToolHeader.astro';
import { tools } from '../../data/tools';
const tool = tools.find((t) => t.id === 'json-formatter')!;
---

<Layout
    title="JSON Formatter | Keeler Tools"
    description="Paste unformatted or minified JSON and get beautifully formatted output with 4-space indentation."
>
    <ToolHeader
        title="JSON Formatter"
        description="Paste your raw or minified JSON and get clean, readable output with 4-space indentation."
        tag="Developer"
        createdAt={tool.createdAt}
    />

    <main class="flex justify-center px-4 py-12">
        <div
            class="relative w-full max-w-screen-lg overflow-hidden rounded-3xl border border-slate-200 bg-white p-4 shadow-xl shadow-slate-200/50 sm:p-6"
        >
            <!-- Background Decoration -->
            <div
                class="pointer-events-none absolute -right-20 top-20 h-64 w-64 rounded-full bg-[radial-gradient(circle,rgba(36,209,248,0.1)_0%,transparent_70%)]"
                aria-hidden="true"
            >
            </div>

            <!-- Input Area -->
            <div class="mb-6">
                <label for="json-input" class="mb-2 block text-sm font-medium text-slate-700"
                    >Input JSON</label
                >
                <textarea
                    id="json-input"
                    rows="8"
                    placeholder='{"name":"example","items":[1,2,3]}'
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 font-mono text-sm text-slate-900 placeholder:text-slate-400 focus:border-brand-dark focus:outline-none focus:ring-1 focus:ring-brand-dark"
                ></textarea>
            </div>

            <!-- Buttons -->
            <div class="mb-6 flex gap-3">
                <button
                    id="format-btn"
                    class="flex items-center gap-2 rounded-xl bg-brand px-6 py-3 font-semibold text-slate-900 transition-all hover:-translate-y-0.5 hover:bg-brand-dark active:translate-y-0"
                >
                    Format
                </button>
                <button
                    id="clear-btn"
                    class="rounded-xl border border-slate-200 bg-white px-6 py-3 font-semibold text-slate-600 transition hover:bg-slate-50 hover:text-slate-900"
                >
                    Clear
                </button>
            </div>

            <!-- Warning Banner -->
            <div
                id="warning-banner"
                class="mb-6 hidden rounded-xl border border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-800"
            >
                <strong>Warning:</strong> Your JSON may have missing brackets. The output below has been
                auto-corrected.
            </div>

            <!-- Error Banner -->
            <div
                id="error-banner"
                class="mb-6 hidden rounded-xl border border-red-300 bg-red-50 px-4 py-3 text-sm text-red-800"
            >
            </div>

            <!-- Output Area -->
            <div id="output-section" class="hidden">
                <div class="mb-2 flex items-center justify-between">
                    <label class="text-sm font-medium text-slate-700">Formatted Output</label>
                    <button
                        id="copy-btn"
                        class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs font-medium text-slate-600 transition hover:bg-slate-50 hover:text-slate-900"
                    >
                        Copy
                    </button>
                </div>
                <pre
                    id="json-output"
                    class="max-h-[32rem] overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm leading-relaxed text-slate-900"><code id="json-output-code" /></pre>
            </div>
        </div>
    </main>
</Layout>

<script>
    const input = document.getElementById('json-input') as HTMLTextAreaElement;
    const formatBtn = document.getElementById('format-btn');
    const clearBtn = document.getElementById('clear-btn');
    const copyBtn = document.getElementById('copy-btn');
    const warningBanner = document.getElementById('warning-banner');
    const errorBanner = document.getElementById('error-banner');
    const outputSection = document.getElementById('output-section');
    const outputCode = document.getElementById('json-output-code');

    formatBtn?.addEventListener('click', formatJson);
    clearBtn?.addEventListener('click', clearAll);
    copyBtn?.addEventListener('click', copyOutput);

    input?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            formatJson();
        }
    });

    function formatJson() {
        const raw = input.value.trim();
        if (!raw) return;

        hideMessages();

        // Try direct parse first
        try {
            const parsed = JSON.parse(raw);
            showOutput(JSON.stringify(parsed, null, 4));
            return;
        } catch {
            // Fall through to bracket recovery
        }

        // Bracket recovery
        const openCurly = (raw.match(/\{/g) || []).length;
        const closeCurly = (raw.match(/\}/g) || []).length;
        const openSquare = (raw.match(/\[/g) || []).length;
        const closeSquare = (raw.match(/\]/g) || []).length;

        let fixed = raw;
        for (let i = 0; i < openSquare - closeSquare; i++) fixed += ']';
        for (let i = 0; i < openCurly - closeCurly; i++) fixed += '}';

        try {
            const parsed = JSON.parse(fixed);
            showOutput(JSON.stringify(parsed, null, 4));
            warningBanner?.classList.remove('hidden');
            return;
        } catch (e) {
            errorBanner!.textContent = `Error: ${(e as SyntaxError).message}`;
            errorBanner?.classList.remove('hidden');
            outputSection?.classList.add('hidden');
        }
    }

    function showOutput(formatted: string) {
        outputCode!.textContent = formatted;
        outputSection?.classList.remove('hidden');
    }

    function hideMessages() {
        warningBanner?.classList.add('hidden');
        errorBanner?.classList.add('hidden');
    }

    function clearAll() {
        input.value = '';
        hideMessages();
        outputSection?.classList.add('hidden');
        outputCode!.textContent = '';
    }

    function copyOutput() {
        const text = outputCode?.textContent || '';
        navigator.clipboard.writeText(text).then(() => {
            const original = copyBtn!.textContent;
            copyBtn!.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn!.textContent = original;
            }, 1500);
        });
    }
</script>
